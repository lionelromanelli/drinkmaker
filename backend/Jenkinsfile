pipeline {
    agent any

    environment {
        // Environment variables
        NODE_ENV = 'production'
        DOCKER_IMAGE = 'drinkmaker-backend'
        DOCKER_TAG = "${BUILD_NUMBER}"

        // Ollama service configuration (configure these in Jenkins credentials)
        OLLAMA_HOST = credentials('ollama-host')

        // Optional: Additional environment variables
        PORT = '3003'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }

        stage('Verify Docker') {
            steps {
                echo 'Verifying Docker is available...'
                sh '''
                    docker --version
                    docker info
                '''
            }
        }

        stage('Debug Branch Info') {
            steps {
                echo 'Checking current branch information...'
                script {
                    echo "Branch Name: ${env.BRANCH_NAME}"
                    echo "Git Branch: ${env.GIT_BRANCH}"
                }
                sh '''
                    echo "Current branch:"
                    git branch -a
                    echo "Current commit:"
                    git log -1 --oneline
                '''
            }
        }

        stage('Docker Build') {
            when {
                anyOf {
                    branch 'main'
                    expression { env.GIT_BRANCH == 'origin/main' }
                }
            }
            steps {
                dir('backend') {
                    echo 'Building Docker image...'
                    sh '''
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                    '''
                }
            }
        }

        stage('Security Scan') {
            when {
                anyOf {
                    branch 'main'
                    expression { env.GIT_BRANCH == 'origin/main' }
                }
            }
            steps {
                dir('backend') {
                    echo 'Running security scan using Docker...'
                    sh '''
                        # Use the built image to run security audit
                        docker run --rm --entrypoint bun ${DOCKER_IMAGE}:${DOCKER_TAG} audit || echo "Security audit completed with warnings"
                    '''
                }
            }
        }

        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    expression { env.GIT_BRANCH == 'origin/main' }
                }
            }
            steps {
                dir('backend') {
                    echo 'Deploying Docker container on port 3003...'
                    sh '''
                        # Stop and remove existing container (if running)
                        docker stop drinkmaker-backend || echo "No existing container to stop"
                        docker rm drinkmaker-backend || echo "No existing container to remove"

                        # Run new container on port 3003
                        docker run -d \\
                            --name drinkmaker-backend \\
                            --restart unless-stopped \\
                            -p 3003:3003 \\
                            -e NODE_ENV=${NODE_ENV} \\
                            -e PORT=${PORT} \\
                            -e OLLAMA_HOST=${OLLAMA_HOST} \\
                            ${DOCKER_IMAGE}:${DOCKER_TAG}

                        # Wait and verify container is running
                        sleep 10
                        if docker ps | grep -q drinkmaker-backend; then
                            echo "✅ DrinkMaker Backend container deployed successfully on port 3003!"
                            docker ps --filter name=drinkmaker-backend
                            docker logs --tail 20 drinkmaker-backend

                            # Test the deployed service
                            echo "Testing deployed service..."
                            curl -f http://localhost:3003/api/health || echo "Service health check failed"
                        else
                            echo "❌ DrinkMaker Backend container deployment failed!"
                            docker logs drinkmaker-backend
                            exit 1
                        fi
                    '''
                }
            }
        }

        stage('Cleanup Old Images') {
            when {
                anyOf {
                    branch 'main'
                    expression { env.GIT_BRANCH == 'origin/main' }
                }
            }
            steps {
                echo 'Cleaning up old Docker images...'
                sh '''
                    # Keep only the 5 most recent images
                    docker images ${DOCKER_IMAGE} --format "table {{.Tag}}\\t{{.CreatedAt}}" | tail -n +2 | head -n -5 | awk '{print $1}' | xargs -r docker rmi ${DOCKER_IMAGE}: || echo "No old images to remove"

                    # Remove dangling images
                    docker image prune -f || echo "No dangling images to remove"
                '''
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            script {
                try {
                    // Cleanup test containers
                    sh '''
                        docker stop test-backend-${BUILD_NUMBER} || true
                        docker rm test-backend-${BUILD_NUMBER} || true
                    '''
                    cleanWs()
                } catch (Exception e) {
                    echo "Workspace cleanup failed: ${e.message}"
                }
            }
            echo 'Clean up end'
        }

        success {
            echo 'DrinkMaker Backend pipeline completed successfully!'
            echo "✅ Backend deployed on port 3003 - Build #${BUILD_NUMBER}"
            // Send success notification (configure webhook/email)
            // slackSend(channel: '#deployments', color: 'good', message: "✅ DrinkMaker Backend deployment successful - Build #${BUILD_NUMBER}")
        }

        failure {
            echo 'DrinkMaker Backend pipeline failed!'
            echo "❌ Backend deployment failed - Build #${BUILD_NUMBER}"
            // Send failure notification
            // slackSend(channel: '#deployments', color: 'danger', message: "❌ DrinkMaker Backend deployment failed - Build #${BUILD_NUMBER}")
        }

        unstable {
            echo 'DrinkMaker Backend pipeline completed with warnings!'
        }
    }
}